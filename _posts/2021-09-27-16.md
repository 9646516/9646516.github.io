---
layout: post
title: "图片的色彩特征"
categories:
  - Category
---

前面提到过，前阵子稍微调研了下传统方法如何判断图片的相似度。梯度信息其实特别容易判断，因为梯度有大量的局部信息，随便选择一种梯度特征都可以。但是颜色特征则不然，在人眼看来相似的颜色，其实RGB差距非常大，即使转换到所谓模拟人眼视觉的HSV或者CIELAB都无法解决这个问题。此外如何度量也有问题，梯度信息由于独特性非常大，因此可以直接用余弦距离。但是色彩容易出现大量的底色(如白色)，用余弦距离会冲淡其他颜色的影响。这意味着，两张图片即使色彩完全不一样，都会因为同时拥有大量的白色底色，导致余弦距离非常小。

之前因为颜色无法有效判断导致暂时没有进展。这几天网上冲浪的时候看了几篇文章，学到了一些技巧之后，终于解决了问题。

第一步是特征的选择。说到颜色的特征，肯定是直方图，直方图可以有效的反映一张图的颜色集中在哪个区域。但是颜色特征还有第二种选择，那就是聚类。使用聚类的方法可以更加合理的将颜色分到一个桶里面。前面的直方图是根据颜色数值，将相邻的颜色装在一个桶里。聚类方法由于可以设计各种各样的距离函数，还可以考虑空间上的距离。但是聚类由于要跑多次，而且直方图的方法由于效果不错，所以很多时候没必要为了一丝的进步使用聚类，而大大加大时间复杂度。

第二步就是颜色空间的选择，虽然所有人都在说RGB空间只是便于存储和表示，不适合计算。但实际上使用RGB已经可以得到不错的结果，而且RGB空间的性质比较好，所有元素都在[0,255]的范围内。不像CIELAB的AB通道，需要截断才能用。

第三步就是如何度量，之前一直没有解决的就是这个问题。

复习一下，常用的距离函数有余弦距离、欧氏距离、相关系数、Chi方距、巴氏距离等。余弦距离的缺点前面已经说了，容易被单一突出的峰值干扰。其他距离的问题是他们都是把对应位置的元素拿出来单独计算距离的。这意味着一张黑色的图片和一张灰色的图片，人眼看起来几乎是一样的，但是算出来距离巨大。也就是说他们没有考虑元素之间的关系。想要解决就必须加大桶的容量，或者寻找其他距离。

后来网上冲浪的时候看到一个距离，Earth Mover’s Distance(EMD)俗称挖土距离。简单的说就是把一个分布变换到另外一个分布的最小代价，这个距离可以有效解决前面提到的普通距离无法解决色偏的问题。一次变换的可以将直方图的$$i,j,k$$位置的像素移动N个单位到$$i_2,j_2,k_2$$的位置，代价为N乘上距离，一般用的是L1距离。

下个问题是如何计算EMD。其实看到这个问题，怎么看都好像在哪见过。后来一想，这不是网络流24题里面的运货问题么。然后一波最小费用最大流就没了。众所周知网络流的复杂度是个玄学，这意味着分桶的时候桶的容量要设置大一些，这可能导致最终的精度下降。但实际上255的范围太大了，即使桶分的大一些仍然可以有效分离不同的颜色。此外EMD有改进算法EMD_L1可以更快的解决网络流复杂度高的问题。

此外可以使用的距离还有Histogram Intersection。这个距离简单的说就是对应位置取min，然后归一化。第一眼看到这个距离的时候的想法就是，这玩意能管用？实际上用了之后发现，仍然无法解决色偏问题，只有加大桶大小之后才能使用。原理也很简单，这个距离其实就是两个直方图的交。这个方法的优点是算的快，如果要求速度的话可以使用这个方法。此外这个方法的输出是[0,1]之间的数字，可以直接表示为概率。如果使用之前的EMD方法，还需要找一个单调函数映射到[0,1]上。





